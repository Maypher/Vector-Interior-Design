name: TQportfolio

services:
    admin-backend:
        build:
            context: ./backend/admin/
        environment:
            - PORT=${ADMIN_PORT}
            - HOST=database
            - USERNAME=${ADMIN_USERNAME}
            - PASSWORD=${ADMIN_PASSWORD}
            - DB_PORT=${DATABASE_PORT}
            - DB_NAME=${DATABASE_NAME}
            - SECRET_KEY=${SERVER_SECRET_KEY}
        volumes:
            - data:/storage/images/
            - data:/storage/database/
        networks:
            - admin
            - backend
        depends_on:
            database:
                condition: service_healthy
                restart: true
        develop:
            watch:
                - action: sync
                  path: ./backend/admin/src/
                  target: /app/src/
        restart: on-failure
    # user-backend:
    #     build: ./backend/user/
    #     volumes:
    #         - data:/storage/database/
    #         - data:/storage/images/
    #     networks:
    #         user:
    #         backend:
    #     depends_on:
    #         - database
    database:
        build: ./database/
        restart: always
        env_file:
            - .env
        environment:
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - POSTGRES_DB=${DATABASE_NAME}
            - ADMIN_USERNAME=${ADMIN_USERNAME}
            - ADMIN_PASSWORD=${ADMIN_PASSWORD}
            - USER_USERNAME=${USER_USERNAME}
            - USER_PASSWORD=${USER_PASSWORD}
            - PGPORT=${DATABASE_PORT}
            - PGUSER=postgres
            - LANG=es_ES.UTF-8
            - LANGUAGE=es_ES.UTF-8
            - LC_ALL=es_ES.UTF-8
        volumes:
            - data:/storage/database/
        networks:
            - backend
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready", "-d", "postgres" ]
            interval: 1m30s
            timeout: 30s
            retries: 5
            start_period: 30s
    nginx:
        build: "./nginx/"
        ports:
            - "8080:80"
        volumes:
            - data:/storage/images/:ro
            - data:/storage/frontend/user/:ro
            - data:/storage/frontend/admin/:ro
        depends_on:
            - admin-backend
        networks:
            - backend
volumes:
    data:
networks:
    user:
    admin:
    backend:
