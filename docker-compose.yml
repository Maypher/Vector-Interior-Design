services:
  payload:
    image: vector-portfolio-payload
    restart: unless-stopped
    build: .
    volumes:
      - images:/app/media
    environment:
      - NEXT_PUBLIC_PAYLOAD_URL=https://${DOMAIN:?Website URL required}
    depends_on:
      - postgres
      - nginx
    secrets:
      - postgres-password
      - payload-secret
  postgres:
    restart: unless-stopped
    image: postgres:17.5-alpine
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres-password
    secrets:
      - postgres-password
  nginx:
    build:
      context: ./nginx
      args:
        ENABLED_MODULES: cachepurge
    restart: unless-stopped
    ports:
      - 443:443
      - 80:80
    environment:
      - NGINX_HOST=${DOMAIN:?Website URL required}

volumes:
  pgdata:
  images:

secrets:
  postgres-password:
    file: .secrets/postgres-password.txt
  payload-secret:
    file: .secrets/payload-secret.txt